package fr.xmalware.badblock.docker.dockers;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import fr.xmalware.badblock.docker.instances.InstanceEntity;
import fr.xmalware.badblock.docker.instances.InstanceSystem;
import fr.xmalware.badblock.docker.instances.WorldSystem;
import fr.xmalware.badblock.docker.openers.LocalOpener;

public class LocalDockerWorker extends Thread
{

	public LocalDockerWorker()
	{
		super("Docker/LocalDocker/Worker");
		this.start();
	}

	@Override
	public void run()
	{	
		try
		{
			Thread.sleep(10000L);
		}
		catch (InterruptedException e)
		{
			e.printStackTrace();
		}
		while (true)
		{

			try
			{
				if (LocalDocker.getConfig() == null || LocalDocker.getConfig().getSystems() == null)
				{
					try
					{
						Thread.sleep(500L);
					}
					catch (InterruptedException e)
					{
						e.printStackTrace();
					}
					continue;
				}

				for (InstanceSystem instanceSystem : LocalDocker.getConfig().getSystems().values())
				{
					for (WorldSystem worldSystem : instanceSystem.getWorlds())
					{
						autoCheck(worldSystem);
					}
				}
			}
			catch (Exception error)
			{
				error.printStackTrace();
			}

			try
			{
				Thread.sleep(500L);
			}
			catch (InterruptedException e)
			{
				e.printStackTrace();
			}
		}
	}

	public void autoCheck(WorldSystem worldSystem)
	{
		try
		{
			int max = Math.abs(worldSystem.getSlots() - worldSystem.getMarginSlots());
			List<InstanceEntity> tempList = new ArrayList<>();
			
			List<List<InstanceEntity>> list = Docker.getInstance().getNet().dockers.values().parallelStream()
					.filter(keep -> keep.getData().getEntities() != null && keep.getData().getEntities().containsKey(worldSystem.getName()))
					.map(keep -> keep.getData().getEntities().get(worldSystem.getName()))
					.collect(Collectors.toList());
			
			list.forEach(l -> tempList.addAll(l));
			
			long count = tempList.parallelStream().filter(ent ->
			ent != null &&
			ent.isConsidered(worldSystem) &&
			ent.getPlayers() < max &&
			ent.getHostId() == null).count();

			if (count > worldSystem.getOffsetServers())
			{
				return;
			}

			LocalOpener.open(worldSystem, "automatic", false, null);
		}
		catch (Exception error)
		{
			error.printStackTrace();
		}
	}

}